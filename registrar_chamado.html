<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrar Chamado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,sans-serif;background:#f9fafb;color:#111827}
    header{background:#fff;border-bottom:1px solid #e5e7eb;text-align:center;padding:18px}
    header img{max-height:80px}
    nav{display:flex;justify-content:flex-end;gap:12px;padding:12px 20px;background:#fff;border-bottom:1px solid #e5e7eb}
    nav a{text-decoration:none;color:#2563eb;font-weight:600}
    main{min-height:calc(100vh - 140px);display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:#fff;border-radius:14px;padding:28px;max-width:760px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
    h1{color:#1d4ed8;margin-bottom:6px;text-align:center}
    p.lead{color:#4b5563;margin-bottom:18px;text-align:center}
    form{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-weight:600;color:#374151}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:6px;font-size:14px}
    textarea{min-height:100px;resize:vertical}
    .priority-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .priority-btn{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;cursor:pointer;font-weight:700}
    .priority-btn.selected{box-shadow:inset 0 -3px 0 rgba(0,0,0,0.06)}
    .btn{background:#2563eb;color:#fff;padding:12px;border-radius:10px;border:none;font-weight:800;cursor:pointer;margin-top:6px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{padding:12px;border-radius:8px;margin-top:12px;display:none}
    .msg.success{background:#d1fae5;color:#065f46;border:1px solid #bbf7d0}
    .msg.error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header><img src="https://raw.githubusercontent.com/MUrilosilvalem/Chamados/refs/heads/main/Logo%20antiga%20com%20a%20nova%20-%201.png" alt="Logo Castro Laborat√≥rio"></header>
  <nav>
    <a href="./index.html">üè† In√≠cio</a>
    <a href="./registrar_chamado.html">üöÄ Registrar</a>
    <a href="./consultar_chamados.html">üìä Consultar</a>
  </nav>

  <main>
    <div class="card">
      <h1>Registrar Chamado</h1>
      <p class="lead">Preencha o formul√°rio e envie ‚Äî o departamento ser√° notificado automaticamente</p>

      <form id="ticketForm" novalidate>
        <div class="row">
          <div>
            <label for="nome">Nome</label>
            <input id="nome" name="nome" type="text" required placeholder="Seu nome completo">
          </div>
          <div>
            <label for="servico">Servi√ßo</label>
            <select id="servico" name="servico" required>
              <option value="">Selecione...</option>
              <option value="ti">TI</option>
              <option value="manutencao">Manuten√ß√£o</option>
              <option value="limpeza">Limpeza</option>
              <option value="rh">Recursos Humanos</option>
            </select>
          </div>
        </div>

        <label for="local">Local</label>
        <select id="local" name="local" required>
          <option value="">Selecione...</option>
          <option value="matriz">Matriz</option>
          <option value="posto_santa_cruz">Posto Santa Cruz</option>
          <option value="posto_avenida_brasilia">Posto Avenida Bras√≠lia</option>
        </select>

        <label>Prioridade</label>
        <div class="priority-group" id="priorityGroup" role="tablist" aria-label="Prioridade">
          <button type="button" class="priority-btn" data-priority="baixa">Baixa</button>
          <button type="button" class="priority-btn" data-priority="media">M√©dia</button>
          <button type="button" class="priority-btn" data-priority="alta">Alta</button>
          <button type="button" class="priority-btn" data-priority="critica">Cr√≠tica</button>
        </div>

        <label for="descricao">Descri√ß√£o</label>
        <textarea id="descricao" name="descricao" required placeholder="Descreva o problema com o m√°ximo de detalhes"></textarea>

        <button id="submitBtn" type="submit" class="btn">üöÄ Enviar Chamado</button>

        <div id="successMsg" class="msg success" role="status"></div>
        <div id="errorMsg" class="msg error" role="alert"></div>
      </form>
    </div>
  </main>

  <script>
    (function(){
      const form = document.getElementById('ticketForm');
      const submitBtn = document.getElementById('submitBtn');
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');
      const priorityGroup = document.getElementById('priorityGroup');
      let selectedPriority = null;

      // Priority selection
      priorityGroup.querySelectorAll('.priority-btn').forEach(btn=>{
        btn.addEventListener('click', () => {
          priorityGroup.querySelectorAll('.priority-btn').forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPriority = btn.dataset.priority;
        });
      });

      function generateTicketId() {
        const d = new Date();
        const year = d.getFullYear();
        const rand = Math.floor(Math.random()*9000)+1000;
        return `#${year}${rand}`;
      }

      function showSuccess(text){
        successMsg.textContent = text;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
      }
      function showError(text){
        errorMsg.textContent = text;
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        // validation
        const nome = form.nome.value.trim();
        const servico = form.servico.value;
        const local = form.local.value;
        const descricao = form.descricao.value.trim();

        if(!nome || !servico || !local || !descricao || !selectedPriority){
          showError('Preencha todos os campos e selecione uma prioridade.');
          return;
        }

        const ticketId = generateTicketId();
        const payload = {
          ticket_id: ticketId,
          timestamp: new Date().toISOString(),
          nome, servico, local, descricao,
          prioridade: selectedPriority
        };

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
          const webhookUrl = 'https://evolution-lab-n8n.jxj99o.easypanel.host/webhook/chamados'; // ajuste se necess√°rio
          const res = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            credentials: 'omit' // deixar omit a n√£o ser que necessite cookies
          });

          // Verifica status HTTP
          if (!res.ok) {
            const txt = await res.text().catch(()=>null);
            throw new Error('Servidor retornou status ' + res.status + (txt ? (' ‚Äî ' + txt) : ''));
          }

          showSuccess(`‚úÖ Chamado ${ticketId} registrado com sucesso. O setor respons√°vel foi notificado.`);
          form.reset();
          selectedPriority = null;
          priorityGroup.querySelectorAll('.priority-btn').forEach(b=>b.classList.remove('selected'));

        } catch (err) {
          console.error('Erro ao enviar chamado:', err);
          // Poss√≠vel CORS / network error
          if (err instanceof TypeError) {
            showError('Falha na requisi√ß√£o ‚Äî verifique conex√£o ou CORS. Abra o console (F12) para mais detalhes.');
          } else {
            showError('Erro ao registrar chamado: ' + err.message);
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'üöÄ Enviar Chamado';
        }
      });
    })();
  </script>
</body>
</html>
